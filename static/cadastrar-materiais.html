<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ativus.AI - Cadastro de Material</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .breadcrumb a {
            color: #10b981;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .form-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .form-header {
            margin-bottom: 30px;
        }
        
        .form-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            min-height: 120px;
        }
        
        .image-upload:hover {
            border-color: #10b981;
        }
        
        .image-upload i {
            font-size: 24px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .image-upload span {
            font-size: 14px;
            color: #6b7280;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .estoque-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .estoque-item {
            display: flex;
            flex-direction: column;
        }
        
        .estoque-item label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .estoque-item input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #10b981;
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .floating-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        
        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
        }
        
        .floating-btn.save {
            background: #10b981;
        }
        
        .floating-btn.save:hover {
            background: #059669;
            transform: scale(1.1);
        }
        
        .floating-btn.back {
            background: #6b7280;
        }
        
        .floating-btn.back:hover {
            background: #4b5563;
            transform: scale(1.1);
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .estoque-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Overlay para mobile -->
        <div class="sidebar-overlay"></div>
        
        <!-- Menu Lateral -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="/static/images/Ativus.png" alt="Ativus.AI Logo" class="sidebar-logo">
                <span class="logo-text">Ativus.AI</span>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="menu">
                    <li class="menu-item">
                        <a href="/cadastro-ativos" class="menu-link">
                            <i class="fas fa-boxes"></i>
                            <span>Cadastro de Ativos</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/plano-manutencao" class="menu-link">
                            <i class="fas fa-tools"></i>
                            <span>Plano de Manutenção</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/abrir-chamado" class="menu-link">
                            <i class="fas fa-headset"></i>
                            <span>Abrir Chamado</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/programacao" class="menu-link">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Programação</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/materiais" class="menu-link active">
                            <i class="fas fa-boxes"></i>
                            <span>Materiais</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/dashboard" class="menu-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/relatorios" class="menu-link">
                            <i class="fas fa-chart-bar"></i>
                            <span>Relatórios</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/monitoramento" class="menu-link">
                            <i class="fas fa-desktop"></i>
                            <span>Monitoramento</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/parametros" class="menu-link">
                            <i class="fas fa-cog"></i>
                            <span>Parâmetros</span>
                        </a>
                    </li>
                    
                    <li class="menu-item">
                        <a href="/scanner-qr" class="menu-link">
                            <i class="fas fa-qrcode"></i>
                            <span>Scanner QR</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <!-- Conteúdo Principal -->
        <div class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                
                <div class="top-bar-right">
                    <div class="user-info">
                        <span id="user-name">Carregando...</span>
                        <span id="user-company">Carregando...</span>
                    </div>
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>
            
            <!-- Área de Conteúdo -->
            <div class="content">
                <!-- Breadcrumb -->
                <div class="breadcrumb">
                    <a href="/materiais">Materiais</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>Cadastro de Material</span>
                </div>
                
                <div class="form-container">
                    <div class="form-header">
                        <h1>Cadastro de Material</h1>
                    </div>
                    
                    <form id="materialForm">
                        <!-- Informações Básicas -->
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="codigo">Código</label>
                                <input type="text" id="codigo" name="codigo" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="descricao">Descrição</label>
                                <input type="text" id="descricao" name="descricao" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="tipoRecurso">Tipo Recurso</label>
                                <select id="tipoRecurso" name="tipoRecurso" required>
                                    <option value="">Selecione...</option>
                                    <option value="Material Estoque">Material Estoque</option>
                                    <option value="Material Consumo">Material Consumo</option>
                                    <option value="Ferramenta">Ferramenta</option>
                                    <option value="EPI">EPI</option>
                                    <option value="Peça de Reposição">Peça de Reposição</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('estoque')">Estoque</div>
                            <div class="tab" onclick="switchTab('identificacao')">Identificação</div>
                        </div>
                        
                        <!-- Tab Estoque -->
                        <div id="estoque-tab" class="tab-content active">
                            <div class="form-section">
                                <div class="estoque-grid">
                                    <div class="estoque-item">
                                        <label>Localização</label>
                                        <select name="localizacao">
                                            <option value="">Selecione...</option>
                                            <option value="Almoxarifado Central">Almoxarifado Central</option>
                                            <option value="Almoxarifado Manutenção">Almoxarifado Manutenção</option>
                                            <option value="Estoque Local">Estoque Local</option>
                                        </select>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Estoque</label>
                                        <input type="number" name="estoque" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Local</label>
                                        <select name="local">
                                            <option value="">Selecione...</option>
                                            <option value="Prateleira A1">Prateleira A1</option>
                                            <option value="Prateleira A2">Prateleira A2</option>
                                            <option value="Prateleira B1">Prateleira B1</option>
                                            <option value="Gaveta 01">Gaveta 01</option>
                                            <option value="Gaveta 02">Gaveta 02</option>
                                        </select>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Valor Unitário</label>
                                        <input type="number" name="valorUnitario" step="0.01" min="0" placeholder="R$ 0,00">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Estoque Real</label>
                                        <input type="number" name="estoqueReal" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Custo Estoque Real</label>
                                        <input type="number" name="custoEstoqueReal" step="0.01" min="0" readonly>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Estoque Ideal</label>
                                        <input type="number" name="estoqueIdeal" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Custo Estoque Ideal</label>
                                        <input type="number" name="custoEstoqueIdeal" step="0.01" min="0" readonly>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Estoque Mínimo</label>
                                        <input type="number" name="estoqueMinimo" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Custo Estoque Mínimo</label>
                                        <input type="number" name="custoEstoqueMinimo" step="0.01" min="0" readonly>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Estoque Máximo</label>
                                        <input type="number" name="estoqueMaximo" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Custo Estoque Máximo</label>
                                        <input type="number" name="custoEstoqueMaximo" step="0.01" min="0" readonly>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Reservado</label>
                                        <input type="number" name="reservado" step="0.01" min="0">
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Custo Reservado O.S.</label>
                                        <input type="number" name="custoReservado" step="0.01" min="0" readonly>
                                    </div>
                                    
                                    <div class="estoque-item">
                                        <label>Status</label>
                                        <select name="status">
                                            <option value="Ativo">Ativo</option>
                                            <option value="Inativo">Inativo</option>
                                            <option value="Descontinuado">Descontinuado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Identificação -->
                        <div id="identificacao-tab" class="tab-content">
                            <div class="form-section">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Família</label>
                                        <select name="familia">
                                            <option value="">Selecione...</option>
                                            <option value="Elétrica">Elétrica</option>
                                            <option value="Mecânica">Mecânica</option>
                                            <option value="Hidráulica">Hidráulica</option>
                                            <option value="Pneumática">Pneumática</option>
                                            <option value="Eletrônica">Eletrônica</option>
                                            <option value="Consumíveis">Consumíveis</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Unidade Medida</label>
                                        <select name="unidadeMedida">
                                            <option value="">Selecione...</option>
                                            <option value="UN">Unidade</option>
                                            <option value="KG">Quilograma</option>
                                            <option value="L">Litro</option>
                                            <option value="M">Metro</option>
                                            <option value="M²">Metro Quadrado</option>
                                            <option value="M³">Metro Cúbico</option>
                                            <option value="PC">Peça</option>
                                            <option value="CX">Caixa</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Imagem do Material</label>
                                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                                        <i class="fas fa-camera"></i>
                                        <span>SELECIONAR IMAGEM</span>
                                        <input type="file" id="imageInput" name="imagem" accept="image/*" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botões Flutuantes -->
    <div class="floating-buttons">
        <button class="floating-btn save" onclick="salvarMaterial()" title="Salvar">
            <i class="fas fa-save"></i>
        </button>
        <button class="floating-btn back" onclick="voltarMateriais()" title="Voltar">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>
    
    <script src="/static/js/user_info.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        // Função para alternar entre tabs
        function switchTab(tabName) {
            // Remove active de todas as tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adiciona active na tab clicada
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Função para calcular custos automaticamente
        function calcularCustos() {
            const valorUnitario = parseFloat(document.querySelector('[name="valorUnitario"]').value) || 0;
            
            // Calcular custo estoque real
            const estoqueReal = parseFloat(document.querySelector('[name="estoqueReal"]').value) || 0;
            document.querySelector('[name="custoEstoqueReal"]').value = (estoqueReal * valorUnitario).toFixed(2);
            
            // Calcular custo estoque ideal
            const estoqueIdeal = parseFloat(document.querySelector('[name="estoqueIdeal"]').value) || 0;
            document.querySelector('[name="custoEstoqueIdeal"]').value = (estoqueIdeal * valorUnitario).toFixed(2);
            
            // Calcular custo estoque mínimo
            const estoqueMinimo = parseFloat(document.querySelector('[name="estoqueMinimo"]').value) || 0;
            document.querySelector('[name="custoEstoqueMinimo"]').value = (estoqueMinimo * valorUnitario).toFixed(2);
            
            // Calcular custo estoque máximo
            const estoqueMaximo = parseFloat(document.querySelector('[name="estoqueMaximo"]').value) || 0;
            document.querySelector('[name="custoEstoqueMaximo"]').value = (estoqueMaximo * valorUnitario).toFixed(2);
            
            // Calcular custo reservado
            const reservado = parseFloat(document.querySelector('[name="reservado"]').value) || 0;
            document.querySelector('[name="custoReservado"]').value = (reservado * valorUnitario).toFixed(2);
        }
        
        // Adicionar event listeners para cálculo automático
        document.addEventListener('DOMContentLoaded', function() {
            const campos = ['valorUnitario', 'estoqueReal', 'estoqueIdeal', 'estoqueMinimo', 'estoqueMaximo', 'reservado'];
            campos.forEach(campo => {
                const elemento = document.querySelector(`[name="${campo}"]`);
                if (elemento) {
                    elemento.addEventListener('input', calcularCustos);
                }
            });
        });
        
        // Função para salvar material
        async function salvarMaterial() {
            const form = document.getElementById('materialForm');
            const formData = new FormData(form);
            
            // Validação básica
            if (!formData.get('codigo') || !formData.get('descricao') || !formData.get('tipoRecurso')) {
                alert('Por favor, preencha os campos obrigatórios: Código, Descrição e Tipo Recurso.');
                return;
            }
            
            // Converter FormData para objeto
            const materialData = Object.fromEntries(formData);
            console.log('Salvando material...', materialData);
            
            try {
                // Mostrar loading
                const saveBtn = document.querySelector('.floating-btn.save');
                const originalIcon = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                saveBtn.disabled = true;
                
                // Enviar dados para a API
                const response = await fetch('/api/materiais', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(materialData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Material cadastrado com sucesso!');
                    // Limpar formulário
                    form.reset();
                    // Recalcular custos
                    calcularCustos();
                    // Opcional: redirecionar para a lista de materiais
                    // window.location.href = '/materiais';
                } else {
                    alert('Erro ao cadastrar material: ' + result.message);
                }
                
            } catch (error) {
                console.error('Erro ao salvar material:', error);
                alert('Erro de conexão. Tente novamente.');
            } finally {
                // Restaurar botão
                const saveBtn = document.querySelector('.floating-btn.save');
                saveBtn.innerHTML = originalIcon;
                saveBtn.disabled = false;
            }
        }
        
        // Função para voltar à tela de materiais
        function voltarMateriais() {
            window.location.href = '/materiais';
        }
        
        // Preview da imagem selecionada
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const uploadDiv = document.querySelector('.image-upload');
                    uploadDiv.innerHTML = `
                        <img src="${e.target.result}" style="max-width: 100%; max-height: 120px; border-radius: 4px;">
                        <span style="margin-top: 8px; font-size: 12px;">Clique para alterar</span>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>
